generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ─── Admin Users ─────────────────────────────────────────────
model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      Role     @default(EDITOR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_users")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  EDITOR
  VIEWER
}

// ─── CMS Pages ───────────────────────────────────────────────
model Page {
  id          String   @id @default(cuid())
  slug        String   @unique
  titleEn     String   @default("")
  titleHe     String   @default("")
  titleAr     String   @default("")
  contentEn   String   @default("") @db.Text
  contentHe   String   @default("") @db.Text
  contentAr   String   @default("") @db.Text
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  seo         SeoMeta?

  @@map("pages")
}

// ─── SEO Meta ────────────────────────────────────────────────
model SeoMeta {
  id              String  @id @default(cuid())
  pageId          String  @unique
  page            Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  metaTitleEn     String  @default("")
  metaTitleHe     String  @default("")
  metaTitleAr     String  @default("")
  metaDescEn      String  @default("") @db.Text
  metaDescHe      String  @default("") @db.Text
  metaDescAr      String  @default("") @db.Text
  ogImage         String  @default("")
  keywords        String  @default("")

  @@map("seo_meta")
}

// ─── Site Settings ───────────────────────────────────────────
model SiteSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String @db.Text

  @@map("site_settings")
}

// ─── Orders ──────────────────────────────────────────────────
model Order {
  id                   String      @id @default(cuid())
  orderNo              String      @unique @default(cuid())
  customerId           String?     // optional FK when user is logged in
  customer             Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerEmail        String
  customerName         String      @default("")
  status               OrderStatus @default(PENDING)
  totalAmount          Decimal     @db.Decimal(10, 2)
  currency             String      @default("USD")
  paddleTransactionId  String?     @unique // Paddle txn_ id for webhook idempotency
  esimOrderId          String?
  esimTransactionId    String?
  packageCode          String
  packageName          String
  destination          String
  dataAmount           String
  validity             String
  iccid                String?
  qrCodeUrl            String?
  smdpAddress          String?
  activationCode       String?
  deviceType           String?    // from checkout passthrough
  supplierCost         Decimal?   @db.Decimal(10, 4) // wholesale cost paid to eSIMaccess (USD)
  errorMessage         String?    @db.Text // last fulfillment error for debugging
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  paidAt               DateTime?

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ─── Package Overrides (admin control over eSIMaccess packages) ────
model PackageOverride {
  id             String   @id @default(cuid())
  packageCode    String   @unique        // eSIMaccess packageCode
  visible        Boolean  @default(true) // show on public website
  customTitle    String?                 // override package name
  customPrice    Decimal? @db.Decimal(10, 2)  // override retail price (USD)
  simCost        Decimal? @db.Decimal(10, 4) // override SIM cost (USD); when null use API wholesale
  paddlePriceId  String?                 // Paddle price_id (pri_xxx) for checkout
  saleBadge      String?                 // e.g. "20% OFF", "HOT", "SALE"
  featured       Boolean  @default(false)
  sortOrder      Int      @default(0)
  notes          String?  @db.Text       // internal admin notes
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("package_overrides")
}

// ─── Fee Settings (Paddle + additional fees for profit calculations) ───
model FeeSettings {
  id                  String   @id @default(cuid())
  paddlePercentageFee Decimal  @db.Decimal(5, 4) @default(0.05)  // e.g. 0.05 = 5%
  paddleFixedFee      Decimal  @db.Decimal(10, 2) @default(0.50) // USD per transaction
  currency            String   @default("USD")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("fee_settings")
}

model AdditionalFee {
  id                  String   @id @default(cuid())
  name                String
  type                AdditionalFeeType  // FIXED or PERCENTAGE
  value               Decimal  @db.Decimal(10, 4)  // fixed amount or rate (e.g. 0.02 = 2%)
  isActive            Boolean  @default(true)
  appliesTo           AdditionalFeeAppliesTo @default(ALL_PRODUCTS)
  selectedProductIds  String?  @db.Text  // JSON array of packageCode when appliesTo = SELECTED_PRODUCTS
  sortOrder           Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("additional_fees")
}

enum AdditionalFeeType {
  FIXED
  PERCENTAGE
}

enum AdditionalFeeAppliesTo {
  ALL_PRODUCTS
  SELECTED_PRODUCTS
}

// ─── Customers (site users / account holders) ───────────────
model Customer {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // hashed; null for Google-only users
  name      String   @default("")
  lastName  String?  // optional
  phone     String?  @unique // E.164; single number, required for credentials login
  googleId  String?  @unique // Google OAuth sub
  newsletter Boolean @default(false)
  resetToken         String?
  resetExpires       DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]

  @@map("customers")
}
